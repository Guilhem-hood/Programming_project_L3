<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memories Atlas — Platform Preview</title>
    <meta
      name="description"
      content="Dive into the Memories Atlas prototype: upload media, geotag moments, and preview the cinematic flight experience."
    />
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
      crossorigin="anonymous"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="../logo.png" />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body class="prototype-page">
    <div class="prototype-bg" aria-hidden="true"></div>
    <header class="hero prototype-hero">
      <nav class="nav">
        <div class="logo">
          <img
            src="../logo.png"
            alt="Stylized earth icon"
            class="logo__icon"
          />
          <div class="logo__text">
            <span>Memories</span>
            <span>Atlas</span>
          </div>
        </div>
        <div class="nav__cta">
          <a class="ghost-link" href="../index.html">Back to landing</a>
          <a class="btn btn--secondary" href="../index.html#contact">
            Contact
          </a>
        </div>
      </nav>
      <div class="platform-map-wrap" style="height:100vh; display:flex; gap:1rem; align-items:stretch;">
        <aside class="pin-sidebar glass-panel" style="width:320px; padding:1rem; display:flex; flex-direction:column; gap:1rem;">
          <h3 style="margin:0 0 .25rem 0;">Add a Pin</h3>
          <small class="eyebrow">Create a custom waypoint</small>

          <label style="font-weight:600; margin-top:.25rem">Title</label>
          <input id="pin-title" type="text" placeholder="E.g. Picnic by the Seine" />

          <label style="font-weight:600; margin-top:.25rem">Description</label>
          <textarea id="pin-desc" rows="3" placeholder="Short memory or notes"></textarea>

          <label style="font-weight:600; margin-top:.25rem">Photos</label>
          <input id="pin-files" type="file" accept="image/*" multiple />
          <div id="thumbs" style="display:flex; gap:.5rem; flex-wrap:wrap; max-height:120px; overflow:auto; padding-top:.5rem;"></div>

          <div style="display:flex; gap:.5rem; align-items:center; justify-content:center;">
            <button id="pick-location" class="btn btn--secondary" type="button">Pick location</button>
          </div>

          <div style="display:flex; gap:.5rem; align-items:center; justify-content:center;">
            <input id="pin-lat" type="text" placeholder="lat" readonly style="width:120px; flex:0 0 120px; text-align:center;" />
            <input id="pin-lng" type="text" placeholder="lng" readonly style="width:120px; flex:0 0 120px; text-align:center;" />
          </div>

          <div style="margin-top:.75rem; display:flex; gap:.5rem;">
            <button id="add-pin" class="btn btn--primary" type="button" style="flex:1">Add Pin</button>
            <button id="clear-form" class="btn btn--ghost" type="button">Clear</button>
          </div>
        </aside>

        <div id="map" style="flex:1; height:100%;"></div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([48.8566, 2.3522], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([48.8566, 2.3522]).addTo(map)
                .bindPopup('Paris, France')
                .openPopup();

            // Pin creation UI
            const pickBtn = document.getElementById('pick-location');
            const latInput = document.getElementById('pin-lat');
            const lngInput = document.getElementById('pin-lng');
            const filesInput = document.getElementById('pin-files');
            const thumbs = document.getElementById('thumbs');
            const addBtn = document.getElementById('add-pin');
            const clearBtn = document.getElementById('clear-form');
            const titleInput = document.getElementById('pin-title');
            const descInput = document.getElementById('pin-desc');

            let pickMode = false;
            let stagedFiles = [];
            const STORAGE_KEY = 'mem-atlas-pins-v1';
            const markersMap = new Map(); // id -> marker

            /* pick button listener removed here so the advanced pick-mode
               handlers (enablePickMode/disablePickMode) defined later
               control the behavior. */

            // Pick mode: allow dragging but detect precise clicks using pointer down/up
            // Small movements (<8px) within a short time count as a click. Toggle button
            // color to indicate active mode; Escape cancels.
            let tempMarker = null;
            let __keyCancelListener = null;
            let __downHandler = null;
            let __upHandler = null;
            let __pickStart = null; /* external storage for pick start to ensure mousedown/up pair uses the same value */
            const CLICK_DIST_PX = 8;
            const CLICK_TIME_MS = 600;

            function enablePickMode() {
              pickMode = true;
              pickBtn.textContent = 'Click map to place';
              pickBtn.classList.remove('btn--secondary');
              pickBtn.classList.add('btn--highlight');
              map.getContainer().style.cursor = 'crosshair';

              __downHandler = function(e){
                // record start point and time
                __pickStart = {pt: e.containerPoint, t: Date.now()};
              };
              __upHandler = function(e){
                const s = __pickStart;
                if(!s) return;
                const dx = e.containerPoint.x - s.pt.x;
                const dy = e.containerPoint.y - s.pt.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const dt = Date.now() - s.t;
                if(dist <= CLICK_DIST_PX && dt <= CLICK_TIME_MS){
                  // treat as click
                  const latlng = e.latlng;
                  latInput.value = latlng.lat.toFixed(6);
                  lngInput.value = latlng.lng.toFixed(6);
                  disablePickMode();
                }
                __pickStart = null;
              };

              map.on('mousedown', __downHandler);
              map.on('mouseup', __upHandler);

              __keyCancelListener = (ev) => {
                if(ev.key === 'Escape' || ev.key === 'Esc') disablePickMode();
              };
              document.addEventListener('keydown', __keyCancelListener);
            }

            function disablePickMode() {
              pickMode = false;
              pickBtn.textContent = 'Pick location';
              pickBtn.classList.remove('btn--highlight');
              pickBtn.classList.add('btn--secondary');
              map.getContainer().style.cursor = '';
              if(tempMarker){ map.removeLayer(tempMarker); tempMarker = null; }
              if(__downHandler) { map.off('mousedown', __downHandler); __downHandler = null; }
              if(__upHandler) { map.off('mouseup', __upHandler); __upHandler = null; }
              if(__keyCancelListener){ document.removeEventListener('keydown', __keyCancelListener); __keyCancelListener = null; }
            }

            pickBtn.addEventListener('click', () => {
              if(!pickMode) enablePickMode(); else disablePickMode();
            });

            filesInput.addEventListener('change', (ev) => {
              thumbs.innerHTML = '';
              stagedFiles = Array.from(ev.target.files);
              stagedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e){
                  const img = document.createElement('img');
                  img.src = e.target.result;
                  img.style.width = '72px';
                  img.style.height = '72px';
                  img.style.objectFit = 'cover';
                  img.style.borderRadius = '8px';
                  thumbs.appendChild(img);
                };
                reader.readAsDataURL(file);
              });
            });

              // Persistence: save/load pins to localStorage
              function savePinsToStorage(){
                try{
                  const pins = [];
                  markersMap.forEach((marker, id) => {
                    const meta = marker._memData; // custom attached data
                    if(meta) pins.push(meta);
                  });
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
                }catch(e){ console.error('savePinsToStorage', e); }
              }

              function createMarkerFromData(data, openPopup=true){
                const m = L.marker([data.lat, data.lng]).addTo(map);
                // store meta on marker
                m._memData = data;
                markersMap.set(data.id, m);

                const popupDiv = document.createElement('div');
                popupDiv.innerHTML = `<strong>${escapeHtml(data.title)}</strong><p>${escapeHtml(data.desc)}</p>`;
                if(Array.isArray(data.images)){
                  data.images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.style.maxWidth = '160px';
                    img.style.display = 'block';
                    img.style.marginTop = '.5rem';
                    img.style.borderRadius = '6px';
                    popupDiv.appendChild(img);
                  });
                }
                const del = document.createElement('button');
                del.textContent = 'Delete pin';
                del.className = 'btn btn--ghost';
                del.style.marginTop = '0.75rem';
                del.addEventListener('click', () => {
                  // remove marker and update storage
                  map.removeLayer(m);
                  markersMap.delete(data.id);
                  savePinsToStorage();
                });
                popupDiv.appendChild(del);

                m.bindPopup(popupDiv);
                if(openPopup) m.openPopup();
              }

              function loadPins(){
                try{
                  const raw = localStorage.getItem(STORAGE_KEY);
                  if(!raw) return;
                  const pins = JSON.parse(raw);
                  (pins||[]).forEach(p => createMarkerFromData(p, false));
                }catch(e){ console.error('loadPins', e); }
              }

              // load any existing pins
              loadPins();

            addBtn.addEventListener('click', async () => {
              const lat = parseFloat(latInput.value);
              const lng = parseFloat(lngInput.value);
              if(Number.isNaN(lat) || Number.isNaN(lng)){
                alert('Please choose a location (pick or use center)');
                return;
              }
              const title = titleInput.value || 'Untitled';
              const desc = descInput.value || '';

              // turn staged files into data URLs
              const images = [];
              if(stagedFiles.length){
                for(const f of stagedFiles){
                  const dataUrl = await fileToDataURL(f);
                  images.push(dataUrl);
                }
              }

              const id = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,7);
              const pinData = { id, title, desc, lat, lng, images };
              createMarkerFromData(pinData, true);
              savePinsToStorage();
              // ensure pick mode (if active) is cancelled and reset form
              try{ disablePickMode(); }catch(e){}
              titleInput.value=''; descInput.value=''; filesInput.value=''; thumbs.innerHTML=''; stagedFiles=[]; latInput.value=''; lngInput.value='';
            });

            clearBtn.addEventListener('click', () => {
              try{ disablePickMode(); }catch(e){}
              titleInput.value=''; descInput.value=''; filesInput.value=''; thumbs.innerHTML=''; stagedFiles=[]; latInput.value=''; lngInput.value='';
            });

            function fileToDataURL(file){
              return new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = e => res(e.target.result);
                r.onerror = rej;
                r.readAsDataURL(file);
              });
            }

            function escapeHtml(s){
              return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            }
        });
        </script>
      </div>
      
    </header>

    <main>
      <!-- main page long-form map has been moved to the header. Removed duplicate #map to avoid DOM conflicts -->
      <section class="section prototype-section">
        <div class="prototype-grid">
          <article class="prototype-card glass-panel">
            <p class="eyebrow">01 — Upload</p>
            <h3>Drag photos & capture metadata</h3>
            <p>
              Import JPG/PNG assets, retain EXIF data, and enrich each memory
              with captions, participants, and ambience.
            </p>
          </article>
          <article class="prototype-card glass-panel">
            <p class="eyebrow">02 — Pin</p>
            <h3>Place waypoints across Paris</h3>
            <p>
              Use search or manual lat/long entry to anchor memories exactly
              where they unfolded—on rooftops, bridges, and hidden courtyards.
            </p>
          </article>
          <article class="prototype-card glass-panel">
            <p class="eyebrow">03 — Fly</p>
            <h3>Preview cinematic transitions</h3>
            <p>
              Trigger spline-based flights that glide above the Seine, curve
              around monuments, and ease into each story panel.
            </p>
          </article>
        </div>
      </section>
    </main>
  </body>
</html>

